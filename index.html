// --- ADMIN REGISTRATION ---
function registerUser() {
    const name = document.getElementById('newUserName').value.trim();
    if (!name) return;

    // Save to Firebase under 'familyMembers'
    db.ref('familyMembers/' + name.toLowerCase()).set({
        displayName: name,
        status: 'free',
        location: 'HOME'
    }).then(() => {
        document.getElementById('newUserName').value = "";
        alert(name + " registered successfully!");
    });
}

// --- LOGIN CHECK ---
function login() {
    const inputName = document.getElementById('userNameInput').value.trim();
    if (!inputName) return alert("Enter your name!");

    const lowerName = inputName.toLowerCase();

    // Set YOUR admin name here
    if (lowerName === "chinmay") { 
        isAdmin = true;
        currentUser = "Chinmay";
        enterApp();
        return;
    }

    // Check if the user is pre-registered in Firebase
    db.ref('familyMembers/' + lowerName).once('value', (snap) => {
        if (snap.exists()) {
            currentUser = snap.val().displayName;
            enterApp();
        } else {
            // "Waiting for confirmation" screen for unknown users
            document.getElementById('loginBox').innerHTML = `
                <h2 style="color:#e74c3c">ðŸš« Access Restricted</h2>
                <p><b>Waiting for confirmation!</b></p>
                <p style="font-size:0.8rem;">The Admin must register "${inputName}" first.</p>
                <button onclick="location.reload()" style="margin-top:10px; cursor:pointer;">Try Again</button>
            `;
        }
    });
}

function enterApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    if (isAdmin) document.getElementById('adminSettings').style.display = 'block';
    startFamilySync();
}

// --- SYNC STATUS (Restoring your UI) ---
function startFamilySync() {
    db.ref('familyMembers').on('value', (snap) => {
        const members = snap.val();
        const listDiv = document.getElementById('familyStatusList');
        listDiv.innerHTML = ""; 

        for (let id in members) {
            const m = members[id];
            listDiv.innerHTML += `
                <div style="display:flex; align-items:center; justify-content:space-between; background:white; padding:15px; margin-bottom:10px; border-radius:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1);">
                    <span style="font-weight:bold; flex:1;">User ${m.displayName}</span>
                    
                    <button onclick="toggleStatus('${id}', '${m.status}')" 
                        style="margin:0 15px; padding:5px 12px; border:1px solid #999; background:#f8f9fa; border-radius:4px; cursor:pointer; min-width:60px;">
                        ${m.status}
                    </button>

                    <button onclick="toggleLocation('${id}', '${m.location}')"
                        style="padding:5px 12px; border:1px solid #999; background:#f8f9fa; border-radius:4px; cursor:pointer; min-width:70px;">
                        ${m.location}
                    </button>
                </div>
            `;
        }
    });
}

function toggleStatus(id, current) {
    const next = current === 'free' ? 'busy' : 'free';
    db.ref('familyMembers/' + id).update({ status: next });
}

function toggleLocation(id, current) {
    const next = current === 'HOME' ? 'LEAVE' : 'HOME';
    db.ref('familyMembers/' + id).update({ location: next });
}

function logout() { location.reload(); }
