<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Master Hub</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root { --primary: #4a90e2; --dark: #2d3748; --success: #2ecc71; --danger: #e74c3c; --bg: #f0f4f8; --border: #cbd5e0; --warning: #f39c12; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; }
        
        /* Fixed Login Alignment */
        #loginScreen { 
            position: fixed; inset: 0; background: var(--primary); 
            display: flex; justify-content: center; align-items: center; z-index: 3000; 
        }
        .login-box { 
            background: white; padding: 40px 30px; border-radius: 20px; 
            text-align: center; width: 85%; max-width: 350px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .container { max-width: 1400px; margin: 0 auto; display: none; padding: 15px 15px 100px 15px; }
        
        /* Status Shelf */
        .status-shelf { display: flex; gap: 10px; overflow-x: auto; padding: 10px 5px; margin-bottom: 15px; background: white; border-radius: 15px; }
        .user-chip { display: flex; align-items: center; gap: 8px; background: #f8fafc; padding: 8px 12px; border-radius: 12px; white-space: nowrap; border: 1px solid #e2e8f0; font-size: 0.85rem; font-weight: 600; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .dot-free { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot-busy { background: var(--danger); }

        /* Free/Busy Slot Control */
        .status-panel { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 1px solid var(--border); }
        .status-btn-row { display: flex; gap: 10px; margin-top: 10px; }
        .status-btn { padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; flex: 1; transition: 0.2s; }

        /* Card Elements */
        .card { background: white; padding: 15px; border-radius: 12px; margin-top: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .item-name { font-size: 1.1rem; font-weight: bold; }
        .default-prompt { color: var(--primary); font-size: 0.75rem; text-decoration: underline; cursor: pointer; display: block; margin: 5px 0; }
        
        .qty-box { float: right; display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 4px 8px; border-radius: 8px; }
        .qty-btn { background: var(--primary); color: white; border: none; width: 24px; height: 24px; border-radius: 4px; font-weight: bold; }

        .control-row { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
        .shift-select { padding: 8px; border-radius: 8px; border: 1px solid #cbd5e0; flex: 1; font-size: 0.8rem; }
        .btn-req { background: var(--warning); color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; }

        /* Grid */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; }
        .column { background: #e2e8f0; padding: 15px; border-radius: 18px; min-height: 120px; }

        /* Modals */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2001; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 20px; padding: 25px; }
        #nightlyPopup { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; justify-content: center; align-items: center; padding: 20px; color: white; text-align: center; }
        .fab { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--success); color: white; border-radius: 50%; border: none; font-size: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-box">
        <h2 style="color:var(--primary); margin-top:0;">üè† Family Hub</h2>
        <input type="text" id="userName" placeholder="Type Your Name" style="width:100%; padding:15px; margin-bottom:20px; border-radius:10px; border:1px solid #ddd; box-sizing: border-box; font-size: 1rem;">
        <button onclick="login()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold; font-size: 1rem; cursor:pointer;">Enter House</button>
    </div>
</div>

<div id="nightlyPopup">
    <div style="background: #2d3748; padding: 30px; border-radius: 20px; border: 2px solid var(--warning); width: 100%; max-width: 400px;">
        <h2 style="color:var(--warning);">üåô Nightly Return</h2>
        <div id="misplacedList" style="margin:20px 0; text-align:left; font-size:1rem; color: #cbd5e0;"></div>
        <button onclick="document.getElementById('nightlyPopup').style.display='none'" style="width:100%; padding:12px; background:var(--success); color:white; border:none; border-radius:10px; font-weight:bold;">I'm on it!</button>
    </div>
</div>

<button class="fab" onclick="openItemModal()">+</button>

<div class="container" id="mainApp">
    <header style="background:white; padding:15px; border-radius:15px; text-align:center; margin-bottom:15px;">
        <h2 style="margin:0; color:var(--primary);">Pantry Dashboard</h2>
    </header>

    <div class="status-shelf" id="familyStatuses"></div>

    <div class="status-panel">
        <h4 style="margin:0; color:var(--dark)">My Status</h4>
        <div class="status-btn-row">
            <button class="status-btn" style="background:var(--success); color:white;" onclick="updateMyStatus('Free')">Set Free</button>
            <button class="status-btn" style="background:var(--danger); color:white;" onclick="updateMyStatus('Busy')">Set Busy</button>
        </div>
    </div>

    <div class="inventory-grid">
        <div class="column"><h3>üç≥ Kitchen</h3><div id="list-Kitchen"></div></div>
        <div class="column"><h3>üçΩÔ∏è Dining</h3><div id="list-Dining"></div></div>
        <div class="column"><h3>üõãÔ∏è Hall</h3><div id="list-Hall"></div></div>
        <div class="column"><h3>üõå Room 1</h3><div id="list-Room1"></div></div>
        <div class="column"><h3>üõå Room 2</h3><div id="list-Room2"></div></div>
        <div class="column"><h3>üõå Room 3</h3><div id="list-Room3"></div></div>
    </div>
</div>

<div id="locCheckModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top:0;">üìç Set Default Home</h3>
        <p id="locCheckText"></p>
        <div id="locYesNo" style="display:flex; gap:10px;">
            <button onclick="confirmDefault(true)" style="flex:1; padding:12px; background:var(--success); color:white; border:none; border-radius:10px; font-weight:bold;">Yes</button>
            <button onclick="confirmDefault(false)" style="flex:1; padding:12px; background:var(--danger); color:white; border:none; border-radius:10px; font-weight:bold;">No</button>
        </div>
        <div id="locSelector" style="display:none; margin-top:20px;">
            <p>Pick the permanent home:</p>
            <select id="newDefaultLoc" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px;">
                <option value="Kitchen">Kitchen</option><option value="Dining">Dining</option>
                <option value="Hall">Hall</option><option value="Room1">Room 1</option>
                <option value="Room2">Room 2</option><option value="Room3">Room 3</option>
            </select>
            <button onclick="saveNewDefault()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">Save Home</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCSbzB3VXoJgpqZGH4hrXj5-EECy2pD2c8",
        authDomain: "familyhub-172f8.firebaseapp.com",
        databaseURL: "https://familyhub-172f8-default-rtdb.firebaseio.com",
        projectId: "familyhub-172f8",
        storageBucket: "familyhub-172f8.firebasestorage.app",
        messagingSenderId: "854442266486",
        appId: "1:854442266486:web:be03aebb29f7537907b457"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = "";
    let activeItemKey = "";
    let activeItemData = {};

    function login() {
        const user = document.getElementById('userName').value.trim();
        if(user) {
            currentUser = user;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateMyStatus('Free');
            startSync();
            setInterval(checkNightlyAudit, 60000); 
        }
    }

    function updateMyStatus(status) {
        if(currentUser) db.ref('users/' + currentUser).update({ status: status });
    }

    function startSync() {
        db.ref('inventory').on('value', (snap) => {
            ["Kitchen", "Dining", "Hall", "Room1", "Room2", "Room3"].forEach(r => {
                const el = document.getElementById(`list-${r}`);
                if(el) el.innerHTML = "";
            });
            snap.forEach(child => {
                const item = child.val();
                const key = child.key;
                const div = document.getElementById(`list-${item.location}`);
                if(div) {
                    const isDefaultMissing = (!item.homeLoc || item.homeLoc === "None");
                    div.innerHTML += `
                        <div class="card">
                            <div class="qty-box">
                                <button class="qty-btn" onclick="updateQty('${key}', -1)">-</button>
                                <b>${item.qty || 1}</b>
                                <button class="qty-btn" onclick="updateQty('${key}', 1)">+</button>
                            </div>
                            <div class="item-name">${item.name}</div>
                            ${isDefaultMissing ? `<span class="default-prompt" onclick="openLocCheck('${key}', '${item.name}', '${item.location}')">Is this the default location?</span>` : ''}
                            <div class="control-row">
                                <select class="shift-select" onchange="shiftItem('${key}', this.value)">
                                    <option value="" disabled selected>Shift to...</option>
                                    <option value="Kitchen">Kitchen</option><option value="Dining">Dining</option>
                                    <option value="Hall">Hall</option><option value="Room1">Room 1</option>
                                    <option value="Room2">Room 2</option><option value="Room3">Room 3</option>
                                </select>
                                <button class="btn-req">Req</button>
                                <span onclick="deleteItem('${key}')" style="cursor:pointer; font-size: 1.2rem;">üóëÔ∏è</span>
                            </div>
                        </div>`;
                }
            });
        });

        const family = ["Mom", "Dad", "Chinmay", "Test"];
        db.ref('users').on('value', (snap) => {
            const shelf = document.getElementById('familyStatuses'); shelf.innerHTML = "";
            const states = snap.val() || {};
            family.forEach(name => {
                const isFree = (states[name] && states[name].status === 'Free');
                shelf.innerHTML += `<div class="user-chip"><span class="dot ${isFree?'dot-free':'dot-busy'}"></span>${name}</div>`;
            });
        });
    }

    function openLocCheck(key, name, loc) {
        activeItemKey = key;
        activeItemData = { name, loc };
        document.getElementById('locCheckText').innerText = `${name} is in ${loc}. Is this its default home?`;
        document.getElementById('locYesNo').style.display = 'flex';
        document.getElementById('locSelector').style.display = 'none';
        document.getElementById('locCheckModal').style.display = 'flex';
    }

    function confirmDefault(isYes) {
        if(isYes) {
            db.ref('inventory/' + activeItemKey).update({ homeLoc: activeItemData.loc });
            document.getElementById('locCheckModal').style.display = 'none';
        } else {
            document.getElementById('locYesNo').style.display = 'none';
            document.getElementById('locSelector').style.display = 'block';
        }
    }

    function saveNewDefault() {
        const newHome = document.getElementById('newDefaultLoc').value;
        db.ref('inventory/' + activeItemKey).update({ homeLoc: newHome });
        document.getElementById('locCheckModal').style.display = 'none';
    }

    function shiftItem(key, newLoc) { db.ref('inventory/' + key).update({ location: newLoc }); }
    function updateQty(key, change) { db.ref('inventory/'+key+'/qty').transaction(q => (q || 1) + change); }
    function deleteItem(key) { if(confirm("Delete item?")) db.ref('inventory/'+key).remove(); }
    
    function openItemModal() {
        const name = prompt("Item Name:");
        const loc = prompt("Where is it now? (Kitchen, Hall, Dining, Room1, Room2, Room3)");
        if(name && loc) db.ref('inventory').push({ name, location: loc, qty: 1, homeLoc: "None" });
    }

    function checkNightlyAudit() {
        const now = new Date();
        if(now.getHours() === 21 && now.getMinutes() === 30) {
            db.ref('inventory').once('value', snap => {
                let list = [];
                snap.forEach(c => {
                    const i = c.val();
                    if(i.homeLoc && i.homeLoc !== "None" && i.location !== i.homeLoc) {
                        list.push(`‚Ä¢ ${i.name} belongs in ${i.homeLoc}`);
                    }
                });
                if(list.length > 0) {
                    document.getElementById('misplacedList').innerHTML = list.join("<br>");
                    document.getElementById('nightlyPopup').style.display = 'flex';
                }
            });
        }
    }
</script>
</body>
</html>
